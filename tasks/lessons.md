# Lessons Learned - ChatApp

## React Migration

- User is learning React from zero. Explain EVERY concept before using it.
- User types code manually to learn. Don't auto-generate large files.
- Teach one concept at a time. Don't rush.
- Always compare React concepts to .NET equivalents when possible.
- User works on 2 different PCs. Always update todo.md so progress syncs via GitHub.

## Project Rules

- Backend is complete and working. Don't modify backend code while there is need to change for increasing performance.
- Frontend was Blazor WASM, migrating to React due to UI freezing.
- **Bitrix24 style UI** is the target design. NOT WhatsApp. Full layout: sol navigation menu + messenger panel.
- **BÜTÜN frontend kodlarını user özü yazır**. Heç bir kodu özün yazma (Edit/Write ilə). İzah et, user yazsın, sonra yoxla. Bug fix daxil — HƏR ŞEYİ user yazır.

## Critical: Backend Configuration

- **Backend URL: `http://localhost:7000`** — NEVER assume a port. Always check `launchSettings.json` first.
- **CORS allowed origins:** `http://localhost:5300`, `http://localhost:5301`, `http://localhost:5173`
- **React Vite runs on default port 5173** (user added it to backend CORS).
- RULE: Before writing ANY URL/port in code, ALWAYS verify from `launchSettings.json` or config files. NEVER guess.

## Mistakes Log

| Date       | Mistake                                                                                                      | Fix                                                      | Rule                                                                                                                                                                                                                                                                                                                                                                                         |
| ---------- | ------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2025-02-15 | Wrote `localhost:5000` for backend API                                                                       | Correct port is `7000` (from launchSettings.json)        | ALWAYS check launchSettings.json before writing any URL                                                                                                                                                                                                                                                                                                                                      |
| 2026-02-16 | Created files directly instead of letting user type manually                                                 | Deleted the file, re-explained code for user to type     | NEVER use Write/Edit to create/modify frontend code. ONLY explain — user types manually                                                                                                                                                                                                                                                                                                      |
| 2026-02-16 | Said "WhatsApp style" but user wants Bitrix24 style                                                          | Updated lessons and todo                                 | ALWAYS confirm design reference with user. Target is Bitrix24, NOT WhatsApp                                                                                                                                                                                                                                                                                                                  |
| 2026-02-16 | Made terrible CSS layout — sidebar overlapped content, used fake data                                        | Must rewrite CSS from scratch, use real backend API data | ALWAYS test CSS visually. NEVER use fake/hardcoded data — use real API from day 1. CSS must be pixel-perfect.                                                                                                                                                                                                                                                                                |
| 2026-02-17 | Used string comparison for enum types (`chat.type === "Conversation"`) but backend sends numbers (`0, 1, 2`) | Changed to number comparison (`chat.type === 0`)         | Backend uses C# enums without JsonStringEnumConverter. ALWAYS check if enum is serialized as string or number. C# default = number. Rule: `0 = Conversation, 1 = Channel, 2 = DepartmentUser`                                                                                                                                                                                                |
| 2026-02-17 | Wrote JSX code directly with Edit tool instead of explaining to user                                         | User reminded again                                      | CSS-dən başqa HEÇBIR frontend koduna Edit/Write ilə əl vurma. Əvvəlcə izah et, user özü yazsın. Sonra sən yoxla, test et. Bu ƏSAS QAYDADIR.                                                                                                                                                                                                                                                  |
| 2026-02-17 | Infinite scroll up bug — sonsuz request, tullanma, yanlış array sırası                                       | Blazor implementasiyasını araşdırıb həll tapıldı         | YENİ funksiya yazmazdan ƏVVƏL: 1) Blazor-da necə edildiyini araşdır 2) Pattern-i React-a uyğunlaşdır. useRef flag, hasMore flag, useLayoutEffect+flushSync scroll bərpası                                                                                                                                                                                                                    |
| 2026-02-17 | Yeni kod yazanda user-ə göstərmədən özü yazdı, bug fix zamanı isə izah edib vaxt itirdi                      | User qaydanı dəqiqləşdirdi                               | YENİ KOD → user-ə göstər, user yazsın. MÖVCUD KODDA BUG FIX / DƏYİŞİKLİK → birbaşa özün Edit ilə düzəlt.                                                                                                                                                                                                                                                                                     |
| 2026-02-19 | Scroll zamanı donma — hər hover-da bütün MessageBubble-lar re-render olurdu                                  | React.memo + useMemo + useCallback ilə həll              | **React Performans Pattern**: 1) List komponentləri `React.memo` ilə wrap et 2) Bahalı hesablamaları `useMemo` ilə memoize et 3) Child-a ötürülən callback-ları `useCallback` ilə stabilləşdir 4) Parent state dəyişikliyi (hover kimi) child-lara yayılmasın — local state istifadə et 5) `selectedChat` kimi object prop-lar memo-nu pozur — gələcəkdə primitive prop-lara keçmək lazımdır |
| 2026-02-20 | EF Core `record` constructor call in LINQ Select — Where clause could not be translated                       | `record` → `class` with `init` properties + object initializer | **EF Core LINQ Projection Rule**: HEÇVAXT `select new RecordType(param1, param2, ...)` constructor call istifadə etmə — EF Core bunu SQL-ə çevirə bilmir. HƏMİŞƏ `select new ClassName { Prop = val }` object initializer istifadə et. `record` əvəzinə `class` with `init` properties yaz. |
| 2026-02-23 | Arxitektura pattern-i pozma riski — düşüncə prosesində controller-ə repository inject etməyi düşündüm | MediatR/CQRS pattern-ə sadiq qaldım — Query+Handler yaratdım | **Arxitektura Qorunması**: Kodun mövcud pattern-ini HƏMİŞƏ qoru. Controller-ə YALNIZ `IMediator` inject olunmalıdır. Bütün business logic Handler-da olmalıdır. Yeni endpoint yaradarkən: 1) Mövcud endpoint-lərin pattern-inə bax 2) Query/Command + Handler yarat 3) Controller-dən yalnız `_mediator.Send()` çağır 4) Repository/UnitOfWork yalnız Handler-da istifadə et |
| 2026-02-23 | `JsonStringEnumConverter` Program.cs-ə qlobal əlavə edildikdə BÜTÜN enum-lar string oldu, frontend sındı | Qlobal converter silindi, yalnız `NodeType` enum-una `[JsonConverter(typeof(JsonStringEnumConverter))]` attribute əlavə edildi | **JsonStringEnumConverter Qaydası**: HEÇVAXT qlobal `AddJsonOptions`-da istifadə etmə — bütün enum-lara təsir edir. Əvəzinə yalnız lazımlı enum-a `[JsonConverter(typeof(JsonStringEnumConverter))]` attribute əlavə et. Bu təhlükəsizdir və yalnız o enum-u string edir. |
| 2026-02-23 | İlk həll olaraq frontend-ə normalizeConversationType() workaround yazdım — hər API response-da, hər SignalR handler-da çağırmaq lazım idi | Problemi kökündən həll etdim — qlobal converter-i silib, yalnız lazımlı enum-a attribute əlavə etdim | **Optimizasiya Prinsipi**: HƏMİŞƏ ilk həlldən sonra dayanıb "daha optimal variant varmı?" soruşmaq lazımdır. Workaround (hər yerdə normalize çağırmaq) əvəzinə kök səbəbi həll et (qlobal converter-i sil). Hər bir dəyişikliyin: 1) Performansa təsirini düşün 2) Minimal kod dəyişikliyi ilə həll tap 3) Gələcəkdə borc yaratmayacaq variant seç 4) Workaround yazmaq əvəzinə problemi kökündən həll et |
| 2026-02-24 | Frontend koddakı kommentə güvənib backend konfiqurasiyanı yoxlamadım — `api.js` "JWT 30 dəq" yazırdı amma `appsettings.json`-da 15 dəq idi. Nəticədə proactive refresh timer (25 dəq) access token-dan (15 dəq) GEC işləyirdi → 10 dəqiqəlik boşluq → 401 seli → infinite loop | Timer-i 25 → 12 dəqiqəyə endirdim, `sessionExpired` kill switch əlavə etdim | **Kommentə GÜVƏNMƏ, Mənbəni YOXLA**: Frontend-dəki comment/dəyər backend konfiqurasiyasına istinad edirsə, HƏMİŞƏ backend-dəki real dəyəri yoxla (`appsettings.json`, `launchSettings.json`). Koddakı comment köhnəlmiş ola bilər. Timing/interval/timeout kimi dəyərlərdə **uyğunsuzluq** kritik bug-lara səbəb olur. QAYDA: Backend konfiqurasiyasına bağlı olan hər frontend dəyərini yazmazdan əvvəl backend mənbəyini oxu. |
